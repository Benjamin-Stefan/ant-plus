import e,{EventEmitter as t}from"events";import*as a from"usb";class s{static MESSAGE_RF=1;static MESSAGE_TX_SYNC=164;static DEFAULT_NETWORK_NUMBER=0;static MESSAGE_CHANNEL_UNASSIGN=65;static MESSAGE_CHANNEL_ASSIGN=66;static MESSAGE_CHANNEL_ID=81;static MESSAGE_CHANNEL_PERIOD=67;static MESSAGE_CHANNEL_SEARCH_TIMEOUT=68;static MESSAGE_CHANNEL_FREQUENCY=69;static MESSAGE_CHANNEL_TX_POWER=96;static MESSAGE_NETWORK_KEY=70;static MESSAGE_TX_POWER=71;static MESSAGE_PROXIMITY_SEARCH=113;static MESSAGE_ENABLE_RX_EXT=102;static MESSAGE_LIB_CONFIG=110;static MESSAGE_CHANNEL_OPEN_RX_SCAN=91;static MESSAGE_STARTUP=111;static MESSAGE_SYSTEM_RESET=74;static MESSAGE_CHANNEL_OPEN=75;static MESSAGE_CHANNEL_CLOSE=76;static MESSAGE_CHANNEL_REQUEST=77;static MESSAGE_CHANNEL_BROADCAST_DATA=78;static MESSAGE_CHANNEL_ACKNOWLEDGED_DATA=79;static MESSAGE_CHANNEL_BURST_DATA=80;static MESSAGE_CHANNEL_EVENT=64;static MESSAGE_CHANNEL_STATUS=82;static MESSAGE_VERSION=62;static MESSAGE_CAPABILITIES=84;static MESSAGE_SERIAL_NUMBER=97;static CHANNEL_TYPE_TWOWAY_RECEIVE=0;static CHANNEL_TYPE_TWOWAY_TRANSMIT=16;static CHANNEL_TYPE_SHARED_RECEIVE=32;static CHANNEL_TYPE_SHARED_TRANSMIT=48;static CHANNEL_TYPE_ONEWAY_RECEIVE=64;static CHANNEL_TYPE_ONEWAY_TRANSMIT=80;static RADIO_TX_POWER_MINUS20DB=0;static RADIO_TX_POWER_MINUS10DB=1;static RADIO_TX_POWER_0DB=2;static RADIO_TX_POWER_PLUS4DB=3;static RESPONSE_NO_ERROR=0;static EVENT_RX_SEARCH_TIMEOUT=1;static EVENT_RX_FAIL=2;static EVENT_TX=3;static EVENT_TRANSFER_RX_FAILED=4;static EVENT_TRANSFER_TX_COMPLETED=5;static EVENT_TRANSFER_TX_FAILED=6;static EVENT_CHANNEL_CLOSED=7;static EVENT_RX_FAIL_GO_TO_SEARCH=8;static EVENT_CHANNEL_COLLISION=9;static EVENT_TRANSFER_TX_START=10;static CHANNEL_IN_WRONG_STATE=21;static CHANNEL_NOT_OPENED=22;static CHANNEL_ID_NOT_SET=24;static CLOSE_ALL_CHANNELS=25;static TRANSFER_IN_PROGRESS=31;static TRANSFER_SEQUENCE_NUMBER_ERROR=32;static TRANSFER_IN_ERROR=33;static MESSAGE_SIZE_EXCEEDS_LIMIT=39;static INVALID_MESSAGE=40;static INVALID_NETWORK_NUMBER=41;static INVALID_LIST_ID=48;static INVALID_SCAN_TX_CHANNEL=49;static INVALID_PARAMETER_PROVIDED=51;static EVENT_QUEUE_OVERFLOW=53;static USB_STRING_WRITE_FAIL=112;static CHANNEL_STATE_UNASSIGNED=0;static CHANNEL_STATE_ASSIGNED=1;static CHANNEL_STATE_SEARCHING=2;static CHANNEL_STATE_TRACKING=3;static CAPABILITIES_NO_RECEIVE_CHANNELS=1;static CAPABILITIES_NO_TRANSMIT_CHANNELS=2;static CAPABILITIES_NO_RECEIVE_MESSAGES=4;static CAPABILITIES_NO_TRANSMIT_MESSAGES=8;static CAPABILITIES_NO_ACKNOWLEDGED_MESSAGES=16;static CAPABILITIES_NO_BURST_MESSAGES=32;static CAPABILITIES_NETWORK_ENABLED=2;static CAPABILITIES_SERIAL_NUMBER_ENABLED=8;static CAPABILITIES_PER_CHANNEL_TX_POWER_ENABLED=16;static CAPABILITIES_LOW_PRIORITY_SEARCH_ENABLED=32;static CAPABILITIES_SCRIPT_ENABLED=64;static CAPABILITIES_SEARCH_LIST_ENABLED=128;static CAPABILITIES_LED_ENABLED=1;static CAPABILITIES_EXT_MESSAGE_ENABLED=2;static CAPABILITIES_SCAN_MODE_ENABLED=4;static CAPABILITIES_PROX_SEARCH_ENABLED=16;static CAPABILITIES_EXT_ASSIGN_ENABLED=32;static CAPABILITIES_FS_ANTFS_ENABLED=64;static TIMEOUT_NEVER=255}class i{static BUFFER_INDEX_MSG_LEN=1;static BUFFER_INDEX_MSG_TYPE=2;static BUFFER_INDEX_CHANNEL_NUM=3;static BUFFER_INDEX_MSG_DATA=4;static BUFFER_INDEX_EXT_MSG_BEGIN=12;static resetSystem(){const e=[];return e.push(0),this.buildMessage(e,s.MESSAGE_SYSTEM_RESET)}static requestMessage(e,t){let a=[];return a=a.concat(this.intToLEHexArray(e)),a.push(t),this.buildMessage(a,s.MESSAGE_CHANNEL_REQUEST)}static setNetworkKey(){const e=[];return e.push(s.DEFAULT_NETWORK_NUMBER),e.push(185),e.push(165),e.push(33),e.push(251),e.push(189),e.push(114),e.push(195),e.push(69),this.buildMessage(e,s.MESSAGE_NETWORK_KEY)}static assignChannel(e,t="receive"){let a=[];if(a=a.concat(this.intToLEHexArray(e)),"receive"===t)a.push(s.CHANNEL_TYPE_TWOWAY_RECEIVE);else if("receive_only"===t)a.push(s.CHANNEL_TYPE_ONEWAY_RECEIVE);else if("receive_shared"===t)a.push(s.CHANNEL_TYPE_SHARED_RECEIVE);else if("transmit"===t)a.push(s.CHANNEL_TYPE_TWOWAY_TRANSMIT);else if("transmit_only"===t)a.push(s.CHANNEL_TYPE_ONEWAY_TRANSMIT);else{if("transmit_shared"!==t)throw new Error("type not allowed");a.push(s.CHANNEL_TYPE_SHARED_TRANSMIT)}return a.push(s.DEFAULT_NETWORK_NUMBER),this.buildMessage(a,s.MESSAGE_CHANNEL_ASSIGN)}static setDevice(e,t,a,i){let n=[];return n=n.concat(this.intToLEHexArray(e)),n=n.concat(this.intToLEHexArray(t,2)),n=n.concat(this.intToLEHexArray(a)),n=n.concat(this.intToLEHexArray(i)),this.buildMessage(n,s.MESSAGE_CHANNEL_ID)}static searchChannel(e,t){let a=[];return a=a.concat(this.intToLEHexArray(e)),a=a.concat(this.intToLEHexArray(t)),this.buildMessage(a,s.MESSAGE_CHANNEL_SEARCH_TIMEOUT)}static setPeriod(e,t){let a=[];return a=a.concat(this.intToLEHexArray(e)),a=a.concat(this.intToLEHexArray(t)),this.buildMessage(a,s.MESSAGE_CHANNEL_PERIOD)}static setFrequency(e,t){let a=[];return a=a.concat(this.intToLEHexArray(e)),a=a.concat(this.intToLEHexArray(t)),this.buildMessage(a,s.MESSAGE_CHANNEL_FREQUENCY)}static setRxExt(){let e=[];return e=e.concat(this.intToLEHexArray(0)),e=e.concat(this.intToLEHexArray(1)),this.buildMessage(e,s.MESSAGE_ENABLE_RX_EXT)}static libConfig(e,t){let a=[];return a=a.concat(this.intToLEHexArray(e)),a=a.concat(this.intToLEHexArray(t)),this.buildMessage(a,s.MESSAGE_LIB_CONFIG)}static openRxScan(){let e=[];return e=e.concat(this.intToLEHexArray(0)),e=e.concat(this.intToLEHexArray(1)),this.buildMessage(e,s.MESSAGE_CHANNEL_OPEN_RX_SCAN)}static openChannel(e){let t=[];return t=t.concat(this.intToLEHexArray(e)),this.buildMessage(t,s.MESSAGE_CHANNEL_OPEN)}static closeChannel(e){let t=[];return t=t.concat(this.intToLEHexArray(e)),this.buildMessage(t,s.MESSAGE_CHANNEL_CLOSE)}static unassignChannel(e){let t=[];return t=t.concat(this.intToLEHexArray(e)),this.buildMessage(t,s.MESSAGE_CHANNEL_UNASSIGN)}static acknowledgedData(e,t){return t=this.intToLEHexArray(e).concat(t),this.buildMessage(t,s.MESSAGE_CHANNEL_ACKNOWLEDGED_DATA)}static broadcastData(e,t){return t=this.intToLEHexArray(e).concat(t),this.buildMessage(t,s.MESSAGE_CHANNEL_BROADCAST_DATA)}static buildMessage(e=[],t=0){const a=[];return a.push(s.MESSAGE_TX_SYNC),a.push(e.length),a.push(t),e.forEach((e=>{a.push(e)})),a.push(this.getChecksum(a)),Buffer.from(a)}static intToLEHexArray(e,t=1){t=t||1;const a=[],s=Buffer.from(this.decimalToHex(e,2*t),"hex");let i=s.length-1;for(;i>=0;)a.push(s[i]),i--;return a}static decimalToHex(e,t){let a=Number(e).toString(16);for(t=t||2;a.length<t;)a="0"+a;return a}static getChecksum(e){let t=0;return e.forEach((e=>{t=(t^e)%255})),t}}class n extends e{idVendor;idProduct;static deviceInUse=[];device;iface;detachedKernelDriver=!1;inEndpoint;outEndpoint;leftover;usedChannels=0;attachedSensors=[];maxChannels=0;_canScan=!1;constructor(e,t,s={}){super(),this.idVendor=e,this.idProduct=t,this.setMaxListeners(50),a.usb.setDebugLevel(s.usbDebugLevel||0)}async canScan(){return Promise.resolve(this._canScan)}async open(){const e=this.getDevices();for(;e.length;)try{const t=e.shift();if(!t)continue;this.device=t,this.device.open(),this.iface=this.device.interfaces[0];try{this.iface&&this.iface.isKernelDriverActive()&&(this.detachedKernelDriver=!0,this.iface.detachKernelDriver())}catch{}this.iface.claim();break}catch{this.device&&this.device.close(),this.device=void 0,this.iface=void 0}if(!this.device)return Promise.resolve(!1);if(n.deviceInUse.push(this.device),!this.iface)throw new Error("Interface not initialized.");return this.inEndpoint=this.iface.endpoints[0],this.inEndpoint.on("data",(e=>{this.onData(e).catch((e=>{console.error(e)}))})),this.inEndpoint.on("error",(e=>{console.error("ERROR RECV: ",e)})),this.inEndpoint.on("end",(()=>{})),this.inEndpoint.startPoll(),this.outEndpoint=this.iface.endpoints[1],await this.reset(),Promise.resolve(!0)}async close(){await this.detachAll(),this.inEndpoint&&this.inEndpoint.stopPoll((()=>{this.iface&&this.iface.release(!0,(()=>{if(this.detachedKernelDriver){this.detachedKernelDriver=!1;try{this.iface?.attachKernelDriver()}catch{}}this.iface=void 0,this.device&&this.device.reset((()=>{this.device?.close(),this.emit("shutdown");const e=n.deviceInUse.indexOf(this.device);e>=0&&n.deviceInUse.splice(e,1),a.usb.listenerCount("attach")&&a.usb.emit("attach",this.device),this.device=void 0}))}))}))}async read(e){const t=e.readUInt8(2);t===s.MESSAGE_STARTUP?await this.write(i.requestMessage(0,s.MESSAGE_CAPABILITIES)):t===s.MESSAGE_CAPABILITIES?(this.maxChannels=e.readUInt8(3),this._canScan=!(6&~e.readUInt8(7)),await this.write(i.setNetworkKey())):t===s.MESSAGE_CHANNEL_EVENT&&e.readUInt8(4)===s.MESSAGE_NETWORK_KEY?this.emit("startup",e):this.emit("read",e)}async write(e){await new Promise(((t,a)=>{this.outEndpoint&&this.outEndpoint.transfer(e,(e=>{e?(console.error("ERROR SEND: ",e),a(e)):t()}))}))}async reset(){await this.detachAll(),this.maxChannels=0,this.usedChannels=0,await this.write(i.resetSystem())}async attach(e,t){if(this.usedChannels<0)return Promise.resolve(!1);if(t){if(0!==this.usedChannels)return Promise.resolve(!1);this.usedChannels=-1}else{if(this.maxChannels<=this.usedChannels)return Promise.resolve(!1);++this.usedChannels}return this.attachedSensors.push(e),Promise.resolve(!0)}async detach(e){const t=this.attachedSensors.indexOf(e);return t<0?Promise.resolve(!1):(this.usedChannels<0?this.usedChannels=0:--this.usedChannels,this.attachedSensors.splice(t,1),Promise.resolve(!0))}async isPresent(){return Promise.resolve(this.getDevices().length>0)}async isScanning(){return Promise.resolve(-1===this.usedChannels)}getDevices(){return a.getDeviceList().filter((e=>e.deviceDescriptor.idVendor===this.idVendor&&e.deviceDescriptor.idProduct===this.idProduct)).filter((e=>-1===n.deviceInUse.indexOf(e)))}async detachAll(){const e=this.attachedSensors;for(const t of e)await t.detach()}async onData(e){if(!e.length)return;if(this.leftover&&(e=Buffer.concat([this.leftover,e]),this.leftover=void 0),164!==e.readUInt8(0))throw new Error("SYNC missing");const t=e.length;let a=0;for(;a<t;){if(a+1===t){this.leftover=e.slice(a);break}const s=a+e.readUInt8(a+1)+4;if(s>t){this.leftover=e.slice(a);break}const i=e.slice(a,s);await this.read(i),a=s}}}const r=[{vendorId:4047,productId:4104},{vendorId:4047,productId:4105}];class c extends e{static deviceInUse=[];device;iface;inEndpoint;outEndpoint;leftover;usedChannels=0;attachedSensors=[];maxChannels=0;_canScan=!1;constructor(){super(),this.setMaxListeners(50)}async canScan(){return Promise.resolve(this._canScan)}async open(){try{this.device||(this.device=await navigator.usb.requestDevice({filters:r})),await this.device.open(),this.iface=this.device.configuration?.interfaces[0],this.iface&&await this.device.claimInterface(this.iface.interfaceNumber)}catch{this.device&&await this.device.close(),this.device=void 0,this.iface=void 0}if(!this.device)return Promise.resolve(!1);if(c.deviceInUse.push(this.device),!this.iface)throw new Error("Interface not initialized.");this.inEndpoint=this.iface.alternate.endpoints.find((e=>"in"===e.direction)),this.outEndpoint=this.iface.alternate.endpoints.find((e=>"out"===e.direction)),await this.reset();const e=async()=>{if(!this.inEndpoint)return;const t=await(this.device?.transferIn(this.inEndpoint.endpointNumber,this.inEndpoint.packetSize));if(!t||!t.data)return e();let a=new Uint8Array(t.data.buffer);if(!a.length)return console.log("Keine Daten empfangen."),e();let s=Buffer.from(a);if(164!==s.readUInt8(0))return console.error("SYNC fehlt"),e();let i=0;const n=a.length;for(;i<n;){if(i+1===n){this.leftover=s.slice(i);break}const e=i+s.readUInt8(i+1)+4;if(e>n){this.leftover=s.slice(i);break}const t=s.slice(i,e);await this.read(t),i=e}await e()};return await e(),!0}async close(){if(await this.detachAll(),this.device){await this.device.close(),this.emit("shutdown");const e=c.deviceInUse.indexOf(this.device);e>=0&&c.deviceInUse.splice(e,1),this.emit("attach",this.device),this.device=void 0}}async read(e){const t=e.readUInt8(2);t===s.MESSAGE_STARTUP?await this.write(i.requestMessage(0,s.MESSAGE_CAPABILITIES)):t===s.MESSAGE_CAPABILITIES?(this.maxChannels=e.readUInt8(3),this._canScan=!(6&~e.readUInt8(7)),await this.write(i.setNetworkKey())):t===s.MESSAGE_CHANNEL_EVENT&&e.readUInt8(4)===s.MESSAGE_NETWORK_KEY?this.emit("startup",e):this.emit("read",e)}async write(e){this.device&&this.outEndpoint&&await this.device.transferOut(this.outEndpoint.endpointNumber,e)}async reset(){await this.detachAll(),this.maxChannels=0,this.usedChannels=0,await this.write(i.resetSystem())}async attach(e,t){if(this.usedChannels<0)return Promise.resolve(!1);if(t){if(0!==this.usedChannels)return Promise.resolve(!1);this.usedChannels=-1}else{if(this.maxChannels<=this.usedChannels)return Promise.resolve(!1);++this.usedChannels}return this.attachedSensors.push(e),Promise.resolve(!0)}async detach(e){const t=this.attachedSensors.indexOf(e);return t<0?Promise.resolve(!1):(this.usedChannels<0?this.usedChannels=0:--this.usedChannels,this.attachedSensors.splice(t,1),Promise.resolve(!0))}async isPresent(){return Promise.resolve(!!this.device)}async isScanning(){return Promise.resolve(-1===this.usedChannels)}async detachAll(){const e=this.attachedSensors;for(const t of e)await t.detach()}}class E extends n{constructor(e={}){super(4047,4104,e)}}class _ extends n{constructor(e={}){super(4047,4105,e)}}class d extends c{constructor(){super()}}var o;!function(e){e[e.INIT_PAGE=0]="INIT_PAGE",e[e.STD_PAGE=1]="STD_PAGE",e[e.EXT_PAGE=2]="EXT_PAGE"}(o||(o={}));function S(e,t,a,s){const n=s.readUInt8(i.BUFFER_INDEX_MSG_DATA);if(a.pageState===o.INIT_PAGE)a.pageState=o.STD_PAGE;else if(n!==a.oldPage||a.pageState===o.EXT_PAGE)switch(a.pageState=o.EXT_PAGE,-129&n){case 1:t.OperatingTime=s.readUInt8(i.BUFFER_INDEX_MSG_DATA+1),t.OperatingTime|=s.readUInt8(i.BUFFER_INDEX_MSG_DATA+2)<<8,t.OperatingTime|=s.readUInt8(i.BUFFER_INDEX_MSG_DATA+3)<<16,t.OperatingTime*=2;break;case 2:t.ManId=s.readUInt8(i.BUFFER_INDEX_MSG_DATA+1),t.SerialNumber=t.DeviceId,t.SerialNumber|=s.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+2)<<16,t.SerialNumber>>>=0;break;case 3:t.HwVersion=s.readUInt8(i.BUFFER_INDEX_MSG_DATA+1),t.SwVersion=s.readUInt8(i.BUFFER_INDEX_MSG_DATA+2),t.ModelNum=s.readUInt8(i.BUFFER_INDEX_MSG_DATA+3);break;case 4:t.PreviousBeat=s.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+2);break;case 5:t.IntervalAverage=s.readUInt8(i.BUFFER_INDEX_MSG_DATA+1),t.IntervalMax=s.readUInt8(i.BUFFER_INDEX_MSG_DATA+2),t.SessionAverage=s.readUInt8(i.BUFFER_INDEX_MSG_DATA+3);break;case 6:t.SupportedFeatures=s.readUInt8(i.BUFFER_INDEX_MSG_DATA+2),t.EnabledFeatures=s.readUInt8(i.BUFFER_INDEX_MSG_DATA+3);break;case 7:{const e=s.readUInt8(i.BUFFER_INDEX_MSG_DATA+1),a=s.readUInt8(i.BUFFER_INDEX_MSG_DATA+2),n=s.readUInt8(i.BUFFER_INDEX_MSG_DATA+3);255!==e&&(t.BatteryLevel=e),t.BatteryVoltage=(15&n)+a/256;switch((112&n)>>>4){case 1:t.BatteryStatus="New";break;case 2:t.BatteryStatus="Good";break;case 3:t.BatteryStatus="Ok";break;case 4:t.BatteryStatus="Low";break;case 5:t.BatteryStatus="Critical";break;default:t.BatteryVoltage=void 0,t.BatteryStatus="Invalid"}break}}!function(e,t){e.BeatTime=t.readUInt16LE(0),e.BeatCount=t.readUInt8(2),e.ComputedHeartRate=t.readUInt8(3)}(t,s.slice(i.BUFFER_INDEX_MSG_DATA+4)),a.oldPage=n,e.emit("hbdata",t),e.emit("hbData",t)}class A{constructor(e){this.DeviceId=e}DeviceId;BeatTime;BeatCount;ComputedHeartRate;OperatingTime;ManId;SerialNumber;HwVersion;SwVersion;ModelNum;PreviousBeat;IntervalAverage;IntervalMax;SessionAverage;SupportedFeatures;EnabledFeatures;BatteryLevel;BatteryVoltage;BatteryStatus}class h extends A{Rssi;Threshold}class I extends t{stick;channel;deviceId;transmissionType;messageQueue=[];decodeDataCbk;statusCbk;constructor(e){super(),this.stick=e,e.on("read",(e=>{this.handleEventMessages(e).catch((e=>{console.error(e)}))}))}async scan(e,t){if(void 0!==this.channel)throw new Error("already attached");if(!this.stick.canScan)throw new Error("stick cannot scan");const a=async e=>{switch(e.msg){case s.MESSAGE_RF:switch(e.code){case s.EVENT_CHANNEL_CLOSED:case s.EVENT_RX_FAIL_GO_TO_SEARCH:return await this.write(i.unassignChannel(0)),!0;case s.EVENT_TRANSFER_TX_COMPLETED:case s.EVENT_TRANSFER_TX_FAILED:case s.EVENT_RX_FAIL:case s.INVALID_SCAN_TX_CHANNEL:{const t=this.messageQueue.shift();return t&&t.cbk&&t.cbk(e.code===s.EVENT_TRANSFER_TX_COMPLETED),this.messageQueue.length&&await this.write(this.messageQueue[0].msg),!0}}break;case s.MESSAGE_CHANNEL_ASSIGN:return await this.write(i.setDevice(0,0,0,0)),!0;case s.MESSAGE_CHANNEL_ID:return await this.write(i.setFrequency(0,t)),!0;case s.MESSAGE_CHANNEL_FREQUENCY:return await this.write(i.setRxExt()),!0;case s.MESSAGE_ENABLE_RX_EXT:return await this.write(i.libConfig(0,224)),!0;case s.MESSAGE_LIB_CONFIG:return await this.write(i.openRxScan()),!0;case s.MESSAGE_CHANNEL_OPEN_RX_SCAN:return process.nextTick((()=>this.emit("attached"))),!0;case s.MESSAGE_CHANNEL_CLOSE:return!0;case s.MESSAGE_CHANNEL_UNASSIGN:return this.statusCbk=void 0,this.channel=void 0,process.nextTick((()=>this.emit("detached"))),!0;case s.MESSAGE_CHANNEL_ACKNOWLEDGED_DATA:return e.code===s.TRANSFER_IN_PROGRESS}return!1};if(await this.stick.isScanning())this.channel=0,this.deviceId=0,this.transmissionType=0,this.statusCbk=a,process.nextTick((()=>this.emit("attached")));else{if(!await this.stick.attach(this,!0))throw new Error("cannot attach");this.channel=0,this.deviceId=0,this.transmissionType=0,this.statusCbk=a,await this.write(i.assignChannel(0,e))}}async attachSensor(e,t,a,n,r,c,E,_){if(void 0!==this.channel)throw new Error("already attached");if(!await this.stick.attach(this,!1))throw new Error("cannot attach");this.channel=e,this.deviceId=a,this.transmissionType=r;this.statusCbk=async t=>{switch(t.msg){case s.MESSAGE_RF:switch(t.code){case s.EVENT_CHANNEL_CLOSED:case s.EVENT_RX_FAIL_GO_TO_SEARCH:return await this.write(i.unassignChannel(e)),!0;case s.EVENT_TRANSFER_TX_COMPLETED:case s.EVENT_TRANSFER_TX_FAILED:case s.EVENT_RX_FAIL:case s.INVALID_SCAN_TX_CHANNEL:{const e=this.messageQueue.shift();return e&&e.cbk&&e.cbk(t.code===s.EVENT_TRANSFER_TX_COMPLETED),this.messageQueue.length&&await this.write(this.messageQueue[0].msg),!0}case s.EVENT_CHANNEL_COLLISION:return!0}break;case s.MESSAGE_CHANNEL_ASSIGN:return await this.write(i.setDevice(e,a,n,r)),!0;case s.MESSAGE_CHANNEL_ID:return await this.write(i.searchChannel(e,c)),!0;case s.MESSAGE_CHANNEL_SEARCH_TIMEOUT:return await this.write(i.setFrequency(e,_)),!0;case s.MESSAGE_CHANNEL_FREQUENCY:return await this.write(i.setPeriod(e,E)),!0;case s.MESSAGE_CHANNEL_PERIOD:return await this.write(i.libConfig(e,224)),!0;case s.MESSAGE_LIB_CONFIG:return await this.write(i.openChannel(e)),!0;case s.MESSAGE_CHANNEL_OPEN:return process.nextTick((()=>this.emit("attached"))),!0;case s.MESSAGE_CHANNEL_CLOSE:return!0;case s.MESSAGE_CHANNEL_UNASSIGN:return this.statusCbk=void 0,this.channel=void 0,process.nextTick((()=>this.emit("detached"))),!0;case s.MESSAGE_CHANNEL_ACKNOWLEDGED_DATA:return t.code===s.TRANSFER_IN_PROGRESS}return!1},await this.write(i.assignChannel(e,t))}async detach(){if(void 0===this.channel)return;await this.write(i.closeChannel(this.channel));if(!await this.stick.detach(this))throw new Error("error detaching")}async write(e){await this.stick.write(e)}async handleEventMessages(e){const t=e.readUInt8(i.BUFFER_INDEX_MSG_TYPE);if(e.readUInt8(i.BUFFER_INDEX_CHANNEL_NUM)===this.channel)if(t===s.MESSAGE_CHANNEL_EVENT){const t={msg:e.readUInt8(i.BUFFER_INDEX_MSG_DATA),code:e.readUInt8(i.BUFFER_INDEX_MSG_DATA+1)};this.statusCbk&&this.statusCbk(t)||(console.log("Unhandled event: "+e.toString("hex")),this.emit("eventData",{message:e.readUInt8(i.BUFFER_INDEX_MSG_DATA),code:e.readUInt8(i.BUFFER_INDEX_MSG_DATA+1)}))}else this.decodeDataCbk&&await this.decodeDataCbk(e)}async send(e,t){this.messageQueue.push({msg:e,cbk:t}),1===this.messageQueue.length&&await this.write(e)}}class l extends I{async scan(e){return await super.scan(e,57)}async attachSensor(e,t,a,s,i,n,r){return await super.attachSensor(e,t,a,s,i,n,r,57)}}class u extends l{constructor(e){super(e),this.decodeDataCbk=this.decodeData.bind(this)}scan(){throw new Error("scanning unsupported")}async attachSensor(e,t,a,s,i,n,r){return await super.attachSensor(e,t,a,s,i,n,r)}async decodeData(e){switch(e.readUInt8(i.BUFFER_INDEX_MSG_TYPE)){case s.MESSAGE_CHANNEL_BROADCAST_DATA:case s.MESSAGE_CHANNEL_ACKNOWLEDGED_DATA:case s.MESSAGE_CHANNEL_BURST_DATA:0===this.deviceId&&this.channel&&await this.write(i.requestMessage(this.channel,s.MESSAGE_CHANNEL_ID)),this.updateState(this.deviceId,e);break;case s.MESSAGE_CHANNEL_ID:this.deviceId=e.readUInt16LE(i.BUFFER_INDEX_MSG_DATA),this.transmissionType=e.readUInt8(i.BUFFER_INDEX_MSG_DATA+3)}}}class T extends u{static deviceType=120;async attach(e,t){await super.attachSensor(e,"receive",t,T.deviceType,0,255,8070),this.state=new A(t)}state;page={oldPage:-1,pageState:o.INIT_PAGE};updateState(e,t){this.state.DeviceId=e,S(this,this.state,this.page,t)}}class N extends l{constructor(e){super(e),this.decodeDataCbk=this.decodeData.bind(this)}async scan(){return await super.scan("receive")}attach(){throw new Error("attach unsupported")}send(){throw new Error("send unsupported")}async decodeData(e){if(e.length<=i.BUFFER_INDEX_EXT_MSG_BEGIN+3||!(128&e.readUInt8(i.BUFFER_INDEX_EXT_MSG_BEGIN)))return void console.log("wrong message format",e.toString("hex"));const t=e.readUInt16LE(i.BUFFER_INDEX_EXT_MSG_BEGIN+1);if(e.readUInt8(i.BUFFER_INDEX_EXT_MSG_BEGIN+3)===this.deviceType())switch(this.createStateIfNew(t),64&e.readUInt8(i.BUFFER_INDEX_EXT_MSG_BEGIN)&&32===e.readUInt8(i.BUFFER_INDEX_EXT_MSG_BEGIN+5)&&this.updateRssiAndThreshold(t,e.readInt8(i.BUFFER_INDEX_EXT_MSG_BEGIN+6),e.readInt8(i.BUFFER_INDEX_EXT_MSG_BEGIN+7)),e.readUInt8(i.BUFFER_INDEX_MSG_TYPE)){case s.MESSAGE_CHANNEL_BROADCAST_DATA:case s.MESSAGE_CHANNEL_ACKNOWLEDGED_DATA:case s.MESSAGE_CHANNEL_BURST_DATA:this.updateState(t,e)}}}class D extends N{deviceType(){return T.deviceType}states={};pages={};createStateIfNew(e){this.states[e]||(this.states[e]=new h(e)),this.pages[e]||(this.pages[e]={oldPage:-1,pageState:o.INIT_PAGE})}updateRssiAndThreshold(e,t,a){this.states[e].Rssi=t,this.states[e].Threshold=a}updateState(e,t){S(this,this.states[e],this.pages[e],t)}}function F(e,t,a){const s=a.readUInt8(i.BUFFER_INDEX_MSG_DATA);if(1===s)t.TimeFractional=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+1),t.TimeInteger=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+2),t.DistanceInteger=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+3),t.DistanceFractional=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+4)>>>4,t.SpeedInteger=15&a.readUInt8(i.BUFFER_INDEX_MSG_DATA+4),t.SpeedFractional=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+5),t.StrideCount=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+6),t.UpdateLatency=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+7);else if(s>=2&&s<=15&&(t.CadenceInteger=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+3),t.CadenceFractional=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+4)>>>4,t.SpeedInteger=15&a.readUInt8(i.BUFFER_INDEX_MSG_DATA+4),t.SpeedFractional=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+5),t.Status=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+7),3===s))t.Calories=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+6);e.emit("ssddata",t),e.emit("ssdData",t)}class R{constructor(e){this.DeviceId=e}DeviceId;TimeFractional;TimeInteger;DistanceInteger;DistanceFractional;SpeedInteger;SpeedFractional;StrideCount;UpdateLatency;CadenceInteger;CadenceFractional;Status;Calories}class U extends R{Rssi;Threshold}class M extends u{static deviceType=124;async attach(e,t){await super.attachSensor(e,"receive",t,M.deviceType,0,255,8134),this.state=new R(t)}state;updateState(e,t){this.state.DeviceId=e,F(this,this.state,t)}}class C extends N{deviceType(){return M.deviceType}states={};createStateIfNew(e){this.states[e]||(this.states[e]=new U(e))}updateRssiAndThreshold(e,t,a){this.states[e].Rssi=t,this.states[e].Threshold=a}updateState(e,t){F(this,this.states[e],t)}}function G(e,t,a){const s=t.CadenceEventTime??0,n=t.CumulativeCadenceRevolutionCount??0,r=t.SpeedEventTime??0,c=t.CumulativeSpeedRevolutionCount??0;let E=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA),_=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+2),d=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+4),o=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+6);if(E!==s){t.CadenceEventTime=E,t.CumulativeCadenceRevolutionCount=_,s>E&&(E+=65536),n>_&&(_+=65536);const a=60*(_-n)*1024/(E-s);isNaN(a)||(t.CalculatedCadence=a,e.emit("cadenceData",t))}if(d!==r){t.SpeedEventTime=d,t.CumulativeSpeedRevolutionCount=o,r>d&&(d+=65536),c>o&&(o+=65536);const a=e.wheelCircumference*(o-c);t.CalculatedDistance=a;const s=1024*a/(d-r);isNaN(s)||(t.CalculatedSpeed=s,e.emit("speedData",t))}}class v{constructor(e){this.DeviceId=e}DeviceId;CadenceEventTime;CumulativeCadenceRevolutionCount;SpeedEventTime;CumulativeSpeedRevolutionCount;CalculatedCadence;CalculatedDistance;CalculatedSpeed}class p extends v{Rssi;Threshold}class B extends u{static deviceType=121;wheelCircumference=2.199;setWheelCircumference(e){this.wheelCircumference=e}async attach(e,t){await super.attachSensor(e,"receive",t,B.deviceType,0,255,8086),this.state=new v(t)}state;updateState(e,t){this.state.DeviceId=e,G(this,this.state,t)}}class w extends N{deviceType(){return B.deviceType}wheelCircumference=2.199;setWheelCircumference(e){this.wheelCircumference=e}states={};createStateIfNew(e){this.states[e]||(this.states[e]=new p(e))}updateRssiAndThreshold(e,t,a){this.states[e].Rssi=t,this.states[e].Threshold=a}updateState(e,t){G(this,this.states[e],t)}}function m(e,t,a){switch(-129&a.readUInt8(i.BUFFER_INDEX_MSG_DATA)){case 1:t.OperatingTime=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+1),t.OperatingTime|=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+2)<<8,t.OperatingTime|=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+3)<<16,t.OperatingTime*=2;break;case 2:t.ManId=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+1),t.SerialNumber=t.DeviceId,t.SerialNumber|=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+2)<<16,t.SerialNumber>>>=0;break;case 3:t.HwVersion=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+1),t.SwVersion=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+2),t.ModelNum=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+3);break;case 4:{const e=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+2),s=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+3);t.BatteryVoltage=(15&s)+e/256;switch((112&s)>>>4){case 1:t.BatteryStatus="New";break;case 2:t.BatteryStatus="Good";break;case 3:t.BatteryStatus="Ok";break;case 4:t.BatteryStatus="Low";break;case 5:t.BatteryStatus="Critical";break;default:t.BatteryVoltage=void 0,t.BatteryStatus="Invalid"}break}case 5:t.Motion=!(1&~a.readUInt8(i.BUFFER_INDEX_MSG_DATA+1))}const s=t.SpeedEventTime??0,n=t.CumulativeSpeedRevolutionCount??0;let r=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+4),c=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+6);if(r!==s){t.SpeedEventTime=r,t.CumulativeSpeedRevolutionCount=c,s>r&&(r+=65536),n>c&&(c+=65536);const a=e.wheelCircumference*(c-n);t.CalculatedDistance=a;const i=1024*a/(r-s);isNaN(i)||(t.CalculatedSpeed=i,e.emit("speedData",t))}}class L{constructor(e){this.DeviceId=e}DeviceId;SpeedEventTime;CumulativeSpeedRevolutionCount;CalculatedDistance;CalculatedSpeed;OperatingTime;ManId;SerialNumber;HwVersion;SwVersion;ModelNum;BatteryVoltage;BatteryStatus;Motion}class f extends L{Rssi;Threshold}class X extends u{static deviceType=123;wheelCircumference=2.199;setWheelCircumference(e){this.wheelCircumference=e}async attach(e,t){await super.attachSensor(e,"receive",t,X.deviceType,0,255,8118),this.state=new L(t)}state;updateState(e,t){this.state.DeviceId=e,m(this,this.state,t)}}class b extends N{deviceType(){return X.deviceType}wheelCircumference=2.199;setWheelCircumference(e){this.wheelCircumference=e}states={};createStateIfNew(e){this.states[e]||(this.states[e]=new f(e))}updateRssiAndThreshold(e,t,a){this.states[e].Rssi=t,this.states[e].Threshold=a}updateState(e,t){m(this,this.states[e],t)}}function y(e,t,a){switch(-129&a.readUInt8(i.BUFFER_INDEX_MSG_DATA)){case 1:t.OperatingTime=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+1),t.OperatingTime|=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+2)<<8,t.OperatingTime|=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+3)<<16,t.OperatingTime*=2;break;case 2:t.ManId=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+1),t.SerialNumber=t.DeviceId,t.SerialNumber|=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+2)<<16,t.SerialNumber>>>=0;break;case 3:t.HwVersion=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+1),t.SwVersion=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+2),t.ModelNum=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+3);break;case 4:{const e=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+2),s=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+3);t.BatteryVoltage=(15&s)+e/256;switch((112&s)>>>4){case 1:t.BatteryStatus="New";break;case 2:t.BatteryStatus="Good";break;case 3:t.BatteryStatus="Ok";break;case 4:t.BatteryStatus="Low";break;case 5:t.BatteryStatus="Critical";break;default:t.BatteryVoltage=void 0,t.BatteryStatus="Invalid"}break}case 5:t.Motion=!(1&~a.readUInt8(i.BUFFER_INDEX_MSG_DATA+1))}const s=t.CadenceEventTime??0,n=t.CumulativeCadenceRevolutionCount??0;let r=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+4),c=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+6);if(r!==s){t.CadenceEventTime=r,t.CumulativeCadenceRevolutionCount=c,s>r&&(r+=65536),n>c&&(c+=65536);const a=60*(c-n)*1024/(r-s);isNaN(a)||(t.CalculatedCadence=a,e.emit("cadenceData",t))}}class g{constructor(e){this.DeviceId=e}DeviceId;CadenceEventTime;CumulativeCadenceRevolutionCount;CalculatedCadence;OperatingTime;ManId;SerialNumber;HwVersion;SwVersion;ModelNum;BatteryVoltage;BatteryStatus;Motion}class P extends g{Rssi;Threshold}class k extends u{static deviceType=122;wheelCircumference=2.199;state;async attach(e,t){await super.attachSensor(e,"receive",t,k.deviceType,0,255,8102),this.state=new g(t)}setWheelCircumference(e){this.wheelCircumference=e}updateState(e,t){this.state.DeviceId=e,y(this,this.state,t)}}class H extends N{deviceType(){return k.deviceType}wheelCircumference=2.199;setWheelCircumference(e){this.wheelCircumference=e}states={};createStateIfNew(e){this.states[e]||(this.states[e]=new P(e))}updateRssiAndThreshold(e,t,a){this.states[e].Rssi=t,this.states[e].Threshold=a}updateState(e,t){y(this,this.states[e],t)}}function O(e,t,a){switch(a.readUInt8(i.BUFFER_INDEX_MSG_DATA)){case 1:if(16===a.readUInt8(i.BUFFER_INDEX_MSG_DATA+1)){1===a.readUInt8(i.BUFFER_INDEX_MSG_DATA+2)&&(t.offset=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+6))}break;case 16:{const e=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+2);255!==e?128&e?(t.PedalPower=127&e,t.RightPedalPower=t.PedalPower,t.LeftPedalPower=100-t.RightPedalPower):(t.PedalPower=127&e,t.RightPedalPower=void 0,t.LeftPedalPower=void 0):(t.PedalPower=void 0,t.RightPedalPower=void 0,t.LeftPedalPower=void 0);const s=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+3);t.Cadence=255!==s?s:void 0,t.AccumulatedPower=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+4),t.Power=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+6);break}case 32:{const e=t.EventCount??0,s=t.TimeStamp??0,n=t.TorqueTicksStamp??0;let r=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+1);const c=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+3);let E=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+5),_=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+7);if(E!==s&&r!==e){t.EventCount=r,e>r&&(r+=255),t.TimeStamp=E,s>E&&(E+=65400),t.Slope=c,t.TorqueTicksStamp=_,n>_&&(_+=65535);const a=5e-4*(E-s),i=_-n,d=a/(r-e),o=Math.round(60/d);t.CalculatedCadence=o;const S=(1/(a/i)-t.offset)/(c/10);t.CalculatedTorque=S,t.CalculatedPower=S*o*Math.PI/30}break}default:return}e.emit("powerData",t)}class x{constructor(e){this.DeviceId=e}DeviceId;PedalPower;RightPedalPower;LeftPedalPower;Cadence;AccumulatedPower;Power;offset=0;EventCount;TimeStamp;Slope;TorqueTicksStamp;CalculatedCadence;CalculatedTorque;CalculatedPower}class V extends x{Rssi;Threshold}class W extends u{static deviceType=11;state;async attach(e,t){await super.attachSensor(e,"receive",t,W.deviceType,0,255,8182),this.state=new x(t)}updateState(e,t){this.state.DeviceId=e,O(this,this.state,t)}}class Y extends N{deviceType(){return W.deviceType}states={};createStateIfNew(e){this.states[e]||(this.states[e]=new V(e))}updateRssiAndThreshold(e,t,a){this.states[e].Rssi=t,this.states[e].Threshold=a}updateState(e,t){O(this,this.states[e],t)}}function K(e){delete e.ElapsedTime,delete e.Distance,delete e.RealSpeed,delete e.VirtualSpeed,delete e.HeartRate,delete e.HeartRateSource,delete e.CycleLength,delete e.Incline,delete e.Resistance,delete e.METs,delete e.CaloricBurnRate,delete e.Calories,delete e._EventCount0x19,delete e._EventCount0x1A,delete e.Cadence,delete e.AccumulatedPower,delete e.InstantaneousPower,delete e.AveragePower,delete e.TrainerStatus,delete e.TargetStatus,delete e.AscendedDistance,delete e.DescendedDistance,delete e.Strides,delete e.Strokes,delete e.WheelTicks,delete e.WheelPeriod,delete e.Torque}function q(e,t,a){switch(a.readUInt8(i.BUFFER_INDEX_MSG_DATA)){case 1:{const e=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+3);255!==e&&(t.Temperature=.5*e-25);const s=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+1);64&s&&(t.ZeroOffset=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+4)),128&s&&(t.SpinDownTime=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+6));break}case 16:{switch(31&a.readUInt8(i.BUFFER_INDEX_MSG_DATA+1)){case 19:t.EquipmentType="Treadmill";break;case 20:t.EquipmentType="Elliptical";break;case 21:t.EquipmentType="Reserved";break;case 22:t.EquipmentType="Rower";break;case 23:t.EquipmentType="Climber";break;case 24:t.EquipmentType="NordicSkier";break;case 25:t.EquipmentType="Trainer/StationaryBike";break;default:t.EquipmentType="General"}let e=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+2),s=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+3);const n=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+4),r=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+6),c=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+7);if(255!==r)switch(3&c){case 3:t.HeartRate=r,t.HeartRateSource="HandContact";break;case 2:t.HeartRate=r,t.HeartRateSource="EM";break;case 1:t.HeartRate=r,t.HeartRateSource="ANT+";break;default:delete t.HeartRate,delete t.HeartRateSource}e/=4;const E=(t.ElapsedTime||0)%64;if(e!==E&&E>e&&(e+=64),t.ElapsedTime=(t.ElapsedTime||0)+e-E,4&c){const e=(t.Distance||0)%256;s!==e&&e>s&&(s+=256),t.Distance=(t.Distance||0)+s-e}else delete t.Distance;switch(8&c?(t.VirtualSpeed=n/1e3,delete t.RealSpeed):(delete t.VirtualSpeed,t.RealSpeed=n/1e3),(112&c)>>4){case 1:t.State="OFF";break;case 2:t.State="READY",K(t);break;case 3:t.State="IN_USE";break;case 4:t.State="FINISHED";break;default:delete t.State}break}case 17:{const e=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+3),s=a.readInt16LE(i.BUFFER_INDEX_MSG_DATA+4),n=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+6),r=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+7);switch(255!==e&&(t.CycleLength=e/100),s>=-1e4&&s<=1e4&&(t.Incline=s/100),255!==n&&(t.Resistance=n),(112&r)>>4){case 1:t.State="OFF";break;case 2:t.State="READY",K(t);break;case 3:t.State="IN_USE";break;case 4:t.State="FINISHED";break;default:delete t.State}break}case 18:{const e=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+2),s=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+4),n=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+6),r=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+7);switch(65535!==e&&(t.METs=e/100),65535!==s&&(t.CaloricBurnRate=s/10),1&r&&(t.Calories=n),(112&r)>>4){case 1:t.State="OFF";break;case 2:t.State="READY",K(t);break;case 3:t.State="IN_USE";break;case 4:t.State="FINISHED";break;default:delete t.State}break}case 19:{const e=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+4);let s=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+5),n=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+6);const r=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+7);if(255!==e&&(t.Cadence=e),2&r){const e=(t.DescendedDistance||0)%256;s!==e&&e>s&&(s+=256),t.DescendedDistance=(t.DescendedDistance||0)+s-e}if(1&r){const e=(t.AscendedDistance||0)%256;n!==e&&e>n&&(n+=256),t.AscendedDistance=(t.AscendedDistance||0)+n-e}switch((112&r)>>4){case 1:t.State="OFF";break;case 2:t.State="READY",K(t);break;case 3:t.State="IN_USE";break;case 4:t.State="FINISHED";break;default:delete t.State}break}case 20:{let e=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+2),s=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+3);const n=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+4),r=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+5),c=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+7);if(255!==n&&(t.Cadence=n),65535!==r&&(t.InstantaneousPower=r),2&c){const a=(t.AscendedDistance||0)%256;e!==a&&a>e&&(e+=256),t.AscendedDistance=(t.AscendedDistance||0)+e-a}if(1&c){const e=(t.Strides||0)%256;s!==e&&e>s&&(s+=256),t.Strides=(t.Strides||0)+s-e}switch((112&c)>>4){case 1:t.State="OFF";break;case 2:t.State="READY",K(t);break;case 3:t.State="IN_USE";break;case 4:t.State="FINISHED";break;default:delete t.State}break}case 22:{let e=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+3);const s=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+4),n=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+5),r=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+7);if(255!==s&&(t.Cadence=s),65535!==n&&(t.InstantaneousPower=n),1&r){const a=(t.Strokes||0)%256;e!==a&&a>e&&(e+=256),t.Strokes=(t.Strokes||0)+e-a}switch((112&r)>>4){case 1:t.State="OFF";break;case 2:t.State="READY",K(t);break;case 3:t.State="IN_USE";break;case 4:t.State="FINISHED";break;default:delete t.State}break}case 23:{let e=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+3);const s=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+4),n=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+5),r=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+7);if(255!==s&&(t.Cadence=s),65535!==n&&(t.InstantaneousPower=n),1&r){const a=(t.Strides||0)%256;e!==a&&a>e&&(e+=256),t.Strides=(t.Strides||0)+e-a}switch((112&r)>>4){case 1:t.State="OFF";break;case 2:t.State="READY",K(t);break;case 3:t.State="IN_USE";break;case 4:t.State="FINISHED";break;default:delete t.State}break}case 24:{let e=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+3);const s=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+4),n=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+5),r=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+7);if(255!==s&&(t.Cadence=s),65535!==n&&(t.InstantaneousPower=n),1&r){const a=(t.Strides||0)%256;e!==a&&a>e&&(e+=256),t.Strides=(t.Strides||0)+e-a}switch((112&r)>>4){case 1:t.State="OFF";break;case 2:t.State="READY",K(t);break;case 3:t.State="IN_USE";break;case 4:t.State="FINISHED";break;default:delete t.State}break}case 25:{const e=t._EventCount0x19||0;let s=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+1);const n=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+2);let r=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+3);const c=4095&a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+5),E=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+6)>>4,_=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+7);if(s!==e&&(t._EventCount0x19=s,e>s&&(s+=255)),255!==n&&(t.Cadence=n),4095!==c){t.InstantaneousPower=c;const a=(t.AccumulatedPower||0)%65536;r!==a&&a>r&&(r+=65536),t.AccumulatedPower=(t.AccumulatedPower||0)+r-a,t.AveragePower=(r-a)/(s-e)}switch(t.TrainerStatus=E,3&_){case 0:t.TargetStatus="OnTarget";break;case 1:t.TargetStatus="LowSpeed";break;case 2:t.TargetStatus="HighSpeed";break;default:delete t.TargetStatus}switch((112&_)>>4){case 1:t.State="OFF";break;case 2:t.State="READY",K(t);break;case 3:t.State="IN_USE";break;case 4:t.State="FINISHED";break;default:delete t.State}break}case 26:{const e=t._EventCount0x1A||0;let s=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+1),n=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+2),r=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+3),c=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+5);const E=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+7);s!==e&&(t._EventCount0x1A=s,e>s&&(s+=255));const _=(t.WheelTicks||0)%256;n!==_&&_>n&&(n+=65536),t.WheelTicks=(t.WheelTicks||0)+n-_;const d=(t.WheelPeriod||0)%256;r!==d&&d>r&&(r+=65536),t.WheelPeriod=(t.WheelPeriod||0)+r-d;const o=(t.Torque||0)%256;switch(c!==o&&o>c&&(c+=65536),t.Torque=(t.Torque||0)+c-o,(112&E)>>4){case 1:t.State="OFF";break;case 2:t.State="READY",K(t);break;case 3:t.State="IN_USE";break;case 4:t.State="FINISHED";break;default:delete t.State}break}case 80:t.HwVersion=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+3),t.ManId=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+4),t.ModelNum=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+6);break;case 81:{const e=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+2),s=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+3),n=a.readInt32LE(i.BUFFER_INDEX_MSG_DATA+4);t.SwVersion=s,255!==e&&(t.SwVersion+=e/1e3),4294967295!==n&&(t.SerialNumber=n);break}case 86:{const e=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+1),s=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+2),n=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+3),r=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+4);a.readUInt8(i.BUFFER_INDEX_MSG_DATA+6);const c=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+7);0===e&&(t.PairedDevices=[]),s>0&&t.PairedDevices.push({id:r,type:c,paired:!!(128&n)});break}default:return}e.emit("fitnessData",t)}class Q{constructor(e){this.DeviceId=e}_EventCount0x19;_EventCount0x1A;DeviceId;Temperature;ZeroOffset;SpinDownTime;EquipmentType;ElapsedTime;Distance;RealSpeed;VirtualSpeed;HeartRate;HeartRateSource;State;CycleLength;Incline;Resistance;METs;CaloricBurnRate;Calories;AscendedDistance;DescendedDistance;Strides;Strokes;Cadence;AccumulatedPower;InstantaneousPower;AveragePower;TrainerStatus;TargetStatus;WheelTicks;WheelPeriod;Torque;HwVersion;ManId;ModelNum;SwVersion;SerialNumber;PairedDevices=[]}class z extends Q{Rssi;Threshold}class Z extends u{static deviceType=17;state;async attach(e,t){await super.attachSensor(e,"receive",t,Z.deviceType,0,255,8192),this.state=new Q(t)}updateState(e,t){this.state.DeviceId=e,q(this,this.state,t)}async setUserConfigurationInternal(e,t,a,s,n){const r=null==e?65535:Math.max(0,Math.min(65534,Math.round(100*e))),c=null==a?255:Math.round(10*a)%10,E=null==t?4095:Math.max(0,Math.min(1e3,Math.round(20*t))),_=[55,255&r,r>>8&255,255,15&c|(15&E)<<4,E>>4&15,255&(null==a?255:Math.max(0,Math.min(254,Math.round(a)))),255&(null==s?0:Math.max(1,Math.min(255,Math.round(s/.03))))],d=i.acknowledgedData(this.channel,_);await this.send(d,n)}async setUserConfiguration(e,t,a,s,i){"function"==typeof e?await this.setUserConfigurationInternal(void 0,void 0,void 0,void 0,e):"function"==typeof t?await this.setUserConfigurationInternal(e,void 0,void 0,void 0,t):"function"==typeof a?await this.setUserConfigurationInternal(e,t,void 0,void 0,a):"function"==typeof s?await this.setUserConfigurationInternal(e,t,a,void 0,s):await this.setUserConfigurationInternal(e,t,a,s,i)}async setBasicResistance(e,t){const a=[48,255,255,255,255,255,255,255&Math.max(0,Math.min(200,Math.round(2*e)))],s=i.acknowledgedData(this.channel,a);await this.send(s,t)}async setTargetPower(e,t){const a=Math.max(0,Math.min(4e3,Math.round(4*e))),s=[49,255,255,255,255,255,255&a,a>>8&255],n=i.acknowledgedData(this.channel,s);await this.send(n,t)}async setWindResistanceInternal(e,t,a,s){const n=[50,255,255,255,255,255&(null==e?255:Math.max(0,Math.min(186,Math.round(100*e)))),255&(null==t?255:Math.max(0,Math.min(254,Math.round(t+127)))),255&(null==a?255:Math.max(0,Math.min(100,Math.round(100*a))))],r=i.acknowledgedData(this.channel,n);await this.send(r,s)}async setWindResistance(e,t,a,s){"function"==typeof e?await this.setWindResistanceInternal(void 0,void 0,void 0,e):"function"==typeof t?await this.setWindResistanceInternal(e,void 0,void 0,t):"function"==typeof a?await this.setWindResistanceInternal(e,t,void 0,a):await this.setWindResistanceInternal(e,t,a,s)}async setTrackResistanceInternal(e,t,a){const s=null==e?65535:Math.max(0,Math.min(4e4,Math.round(100*(e+200)))),n=[51,255,255,255,255,255&s,s>>8&255,255&(null==t?255:Math.max(0,Math.min(254,Math.round(2e4*t))))],r=i.acknowledgedData(this.channel,n);await this.send(r,a)}async setTrackResistance(e,t,a){"function"==typeof e?await this.setTrackResistanceInternal(void 0,void 0,e):"function"==typeof t?await this.setTrackResistanceInternal(e,void 0,t):await this.setTrackResistanceInternal(e,t,a)}}class j extends N{deviceType(){return Z.deviceType}states={};createStateIfNew(e){this.states[e]||(this.states[e]=new z(e))}updateRssiAndThreshold(e,t,a){this.states[e].Rssi=t,this.states[e].Threshold=a}updateState(e,t){q(this,this.states[e],t)}}function J(e,t,a){const s=t._EventCount||0,n=a.readUInt8(i.BUFFER_INDEX_MSG_DATA);switch(n){case 1:{let e=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+1);const n=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+2),r=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+3),c=4095&a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+4),E=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+5)>>4&1023,_=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+6)>>6&1023;switch(e!==s&&(t._EventCount=e,s>e&&(e+=255)),t.UTCTimeRequired=!(1&~n),t.SupportANTFS=!(1&~r),r>>1&7){case 1:t.MeasurementInterval=.25;break;case 2:t.MeasurementInterval=.5;break;case 3:t.MeasurementInterval=1;break;case 4:t.MeasurementInterval=2;break;default:delete t.MeasurementInterval}switch(c){case 4094:t.TotalHemoglobinConcentration="AmbientLightTooHigh";break;case 4095:t.TotalHemoglobinConcentration="Invalid";break;default:t.TotalHemoglobinConcentration=c}switch(E){case 1022:t.PreviousSaturatedHemoglobinPercentage="AmbientLightTooHigh";break;case 1023:t.PreviousSaturatedHemoglobinPercentage="Invalid";break;default:t.PreviousSaturatedHemoglobinPercentage=E}switch(_){case 1022:t.CurrentSaturatedHemoglobinPercentage="AmbientLightTooHigh";break;case 1023:t.CurrentSaturatedHemoglobinPercentage="Invalid";break;default:t.CurrentSaturatedHemoglobinPercentage=_}break}case 80:t.HwVersion=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+3),t.ManId=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+4),t.ModelNum=a.readUInt16LE(i.BUFFER_INDEX_MSG_DATA+6);break;case 81:{const e=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+2),s=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+3),n=a.readInt32LE(i.BUFFER_INDEX_MSG_DATA+4);t.SwVersion=s,255!==e&&(t.SwVersion+=e/1e3),4294967295!==n&&(t.SerialNumber=n);break}case 82:{a.readUInt8(i.BUFFER_INDEX_MSG_DATA+2);const e=16777215&a.readUInt32LE(i.BUFFER_INDEX_MSG_DATA+3),s=a.readInt32LE(i.BUFFER_INDEX_MSG_DATA+6),n=a.readInt32LE(i.BUFFER_INDEX_MSG_DATA+7);t.OperatingTime=e*(128&~n?16:2),t.BatteryVoltage=(15&n)+s/256;switch((112&n)>>>4){case 1:t.BatteryStatus="New";break;case 2:t.BatteryStatus="Good";break;case 3:t.BatteryStatus="Ok";break;case 4:t.BatteryStatus="Low";break;case 5:t.BatteryStatus="Critical";break;default:t.BatteryVoltage=void 0,t.BatteryStatus="Invalid"}break}default:return}1===n&&t._EventCount===s||e.emit("oxygenData",t)}class ${constructor(e){this.DeviceId=e}_EventCount;DeviceId;UTCTimeRequired;SupportANTFS;MeasurementInterval;TotalHemoglobinConcentration;PreviousSaturatedHemoglobinPercentage;CurrentSaturatedHemoglobinPercentage;HwVersion;ManId;ModelNum;SwVersion;SerialNumber;OperatingTime;BatteryVoltage;BatteryStatus}class ee extends ${Rssi;Threshold}class te extends u{static deviceType=31;state;async attach(e,t){await super.attachSensor(e,"receive",t,te.deviceType,0,255,8192),this.state=new $(t)}updateState(e,t){this.state.DeviceId=e,J(this,this.state,t)}async _sendTimeCmd(e,t){const a=new Date,s=Math.round((a.getTime()-Date.UTC(1989,11,31,0,0,0,0))/1e3),n=[16,255&e,255,255&-Math.round(a.getTimezoneOffset()/15),255&s,s>>8&255,s>>16&255,s>>24&255],r=i.acknowledgedData(this.channel,n);await this.send(r,t)}async setUTCTime(e){await this._sendTimeCmd(0,e)}async startSession(e){await this._sendTimeCmd(1,e)}async stopSession(e){await this._sendTimeCmd(2,e)}async setLap(e){await this._sendTimeCmd(3,e)}}class ae extends N{deviceType(){return te.deviceType}states={};createStateIfNew(e){this.states[e]||(this.states[e]=new ee(e))}updateRssiAndThreshold(e,t,a){this.states[e].Rssi=t,this.states[e].Threshold=a}updateState(e,t){J(this,this.states[e],t)}}function se(e,t,a){1===a.readUInt8(i.BUFFER_INDEX_MSG_DATA)&&(t.EventCount=a.readUInt8(i.BUFFER_INDEX_MSG_DATA+2),t.Temperature=a.readInt16LE(i.BUFFER_INDEX_MSG_DATA+6)/100),e.emit("envdata",t),e.emit("envData",t)}class ie{constructor(e){this.DeviceId=e}DeviceId;EventCount;Temperature}class ne extends ie{Rssi;Threshold}class re extends u{static deviceType=25;async attach(e,t){await super.attachSensor(e,"receive",t,re.deviceType,0,255,8192),this.state=new ie(t)}state;updateState(e,t){this.state.DeviceId=e,se(this,this.state,t)}}class ce extends N{deviceType(){return re.deviceType}states={};createStateIfNew(e){this.states[e]||(this.states[e]=new ne(e))}updateRssiAndThreshold(e,t,a){this.states[e].Rssi=t,this.states[e].Threshold=a}updateState(e,t){se(this,this.states[e],t)}}export{Y as BicyclePowerScanner,W as BicyclePowerSensor,H as CadenceScanner,k as CadenceSensor,ce as EnvironmentScanner,re as EnvironmentSensor,j as FitnessEquipmentScanner,Z as FitnessEquipmentSensor,E as GarminStick2,_ as GarminStick3,D as HeartRateScanner,T as HeartRateSensor,ae as MuscleOxygenScanner,te as MuscleOxygenSensor,w as SpeedCadenceScanner,B as SpeedCadenceSensor,b as SpeedScanner,X as SpeedSensor,C as StrideSpeedDistanceScanner,M as StrideSpeedDistanceSensor,d as WebUsbStick};
//# sourceMappingURL=ant-plus-next.mjs.map
